<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>here</title>
    <link rel="import" href="key.html">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <style>
        html, body, #container {
            height: 100%;
        }

        #container {
            height: 90%;
        }

        .info {
            width: 26rem;
        }
    </style>

</head>
<body>
<div id="container"></div>
<!--<div class="info" hidden>
    <h4 id='status'></h4>
    <hr>
    <p id='result'></p>
    <hr>
</div>-->

<button id="show-others">显示其他坐标</button>
<button id="get-location">定位</button>
</body>
<!--引入高德地图JSAPI -->
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>

<!--引入UI组件库（1.0版本） -->
<!--<script src="//webapi.amap.com/ui/1.0/main.js"></script>-->
<script type="text/javascript">
    <!-- 创建地图 -->
    var map = new AMap.Map('container', {
        zoom: 18,
        // viewMode: '3D',
        resizeEnable: true
    });

    map.on('complete', function () {
        console.log('地图加载完成');

    });


    // 这个变量用来调用地理编码功能
    let geoCoder;
    // AMap.Geocoder 地理编码与逆地理编码服务，提供地址与坐标间的相互转换
    AMap.plugin('AMap.Geocoder', function () {
        geoCoder = new AMap.Geocoder({
            // city 指定进行编码查询的城市，支持传入城市名、adcode 和 citycode
            city: '010'
        });
    });

    let myPosition = {};

    let geolocation;
    /**
     * AMap.Geolocation插件
     * 实现定位
     */
    AMap.plugin('AMap.Geolocation', function () {
        console.log('定位中...');
        geolocation = new AMap.Geolocation({
            // 是否使用高精度定位,默认true
            enableHighAccuracy: true,
            // 设置定位超时时间,默认:无穷大
            timeout: 10000,
            // 定位按钮停靠位置的偏移量,默认:Pixel(10,20)
            buttonOffset: new AMap.Pixel(10, 20),
            //定位成功后是否自动调整地图视野到定位点
            zoomToAccuracy: true
        });

        map.addControl(geolocation);

        geolocation.getCurrentPosition(function (status, result) {
            if (status === 'complete') {
                onComplete(result)
            } else {
                onError(result)
            }
        });
    });

    // 完成定位结果
    function onComplete(data) {
        // data是具体的定位信息
        myPosition.lng = data.position.lng;
        myPosition.lat = data.position.lat;

        // map.setCenter(new AMap.LngLat(myPosition.lng, myPosition.lat));

        console.log('定位结果：' + data.position);
        console.log('定位类别：' + data.location_type);
        if (data.accuracy) {
            console.log('精度：' + data.accuracy + ' 米');
        }
        console.log('是否经过偏移：' + (data.isConverted ? '是' : '否'));

        geoCoder.getAddress([myPosition.lng, myPosition.lat], function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                // result为对应的地理位置详细信息
                myPosition.address = result.regeocode.formattedAddress;
                console.log('当前位置 ', myPosition.address);
            } else {
                console.log('位置查询失败 ', result);
                myPosition.address = '未知';
            }
        });

        // savePosition(myPosition);

        // document.getElementById('status').innerHTML = '定位成功';
        // var str = [];
        // str.push('定位结果：' + data.position);
        // str.push('定位类别：' + data.location_type);
        // if (data.accuracy) {
        // str.push('精度：' + data.accuracy + ' 米');
        // }//如为IP精确定位结果则没有精度信息
        // str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
        // document.getElementById('result').innerHTML = str.join('<br>');
    }

    //解析定位错误信息
    function onError(data) {
        console.log('定位失败 ', data.message);
    }


</script>
<script>
    $('#show-others').on('click', function () {
        console.log('获取其他坐标');

        $.ajax({
            url: "/position/random",
            method: 'POST',
            success: function (result) {
                console.log('获取坐标成功 ', result);
                const positions = result.data;
                positions.forEach(function (position) {
                    addMarker([position.lng, position.lat], endIcon, position.address, map);
                })

            }
        });
        // var marker1 = new AMap.Marker({
        //     position: new AMap.LngLat(myPosition.lng, myPosition.lat),   // 经纬度对象，也可以是经纬度构成的一维数组[116.39, 39.9]
        //     title: '这是谁'
        // });
        // var marker2 = new AMap.Marker({
        //     position: new AMap.LngLat(myPosition.lng + 0.0001, myPosition.lat),   // 经纬度对象，也可以是经纬度构成的一维数组[116.39, 39.9]
        //     title: '这是我'
        // });
        // // 多个点实例组成的数组
        // var markerList = [marker1, marker2];
        // // 将创建的点标记添加到已有的地图实例：
        // map.add(markerList);
    });


    $('#get-location').on('click', function () {
        console.log('定位...');

        geolocation.getCurrentPosition(function (status, result) {
            if (status === 'complete') {
                onComplete(result)
            } else {
                onError(result)
            }
        });
    });

    // TODO 18-11-30 00:43 记录位置

    // TODO 18-11-30 00:44 查看指定时间内的其他位置

</script>

</html>